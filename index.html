<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevPush | VS Code Experience</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/vscode-dark.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { 
            --bg-dark: #1e1e1e; 
            --bg-sidebar: #252526; 
            --bg-activity: #333333; 
            --text-main: #d4d4d4; 
            --text-muted: #858585; 
            --accent: #007acc; 
            --border: #3e3e42;
        }
        body { background: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* Auth */
        .auth-wrapper { height: 100vh; display: flex; align-items: center; justify-content: center; background: #000; }
        .auth-card { background: var(--bg-sidebar); padding: 40px; border: 1px solid var(--border); border-radius: 8px; width: 100%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .auth-card input { background: #3c3c3c; border: 1px solid #3c3c3c; color: white; margin-bottom: 15px; }
        .auth-card input:focus { background: #3c3c3c; color: white; border-color: var(--accent); box-shadow: none; }
        
        /* Layout */
        .ide-container { display: flex; height: 100vh; flex-direction: column; }
        .ide-navbar { background: #3c3c3c; height: 40px; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; font-size: 0.9rem; border-bottom: 1px solid #111; }
        .main-area { display: flex; flex-grow: 1; height: calc(100vh - 40px); }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--bg-activity); display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; }
        .sidebar-header { padding: 10px 15px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; }
        .file-tree { flex-grow: 1; overflow-y: auto; padding: 0; }
        
        /* File List Items */
        .tree-item { padding: 4px 15px; cursor: pointer; display: flex; align-items: center; font-size: 0.9rem; color: #cccccc; border-left: 3px solid transparent; }
        .tree-item:hover { background: #2a2d2e; }
        .tree-item.active { background: #37373d; border-left-color: var(--accent); color: white; }
        .folder-part { color: #6f7075; font-size: 0.85rem; margin-right: 2px; }
        .file-part { font-family: 'Inter', sans-serif; }
        .file-actions { margin-left: auto; display: none; gap: 8px; font-size: 0.8rem; }
        .tree-item:hover .file-actions { display: flex; }
        
        /* Editor */
        .editor-wrapper { flex-grow: 1; display: flex; flex-direction: column; background: var(--bg-dark); position: relative; }
        .tab-bar { background: var(--bg-dark); display: flex; align-items: center; height: 35px; border-bottom: 1px solid #2b2b2b; }
        .active-tab { background: #1e1e1e; color: white; padding: 0 15px; height: 100%; display: flex; align-items: center; border-top: 1px solid var(--accent); font-size: 0.9rem; }
        .CodeMirror { flex-grow: 1; font-family: 'Fira Code', monospace; font-size: 14px; line-height: 1.5; }
        
        /* Mobile Overlay */
        .mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; height: 100%; z-index: 100; box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
            .sidebar.open { left: 0; }
            .mobile-overlay.open { display: block; }
        }
    </style>
</head>
<body>

<div id="authSection" class="auth-wrapper hidden">
    <div class="auth-card text-center">
        <h4 class="fw-bold mb-4 text-white"><i class="fas fa-code text-primary"></i> DevPush IDE</h4>
        <div id="regFields" class="hidden">
            <input type="text" id="regName" class="form-control" placeholder="Full Name">
            <input type="text" id="regPhone" class="form-control" placeholder="Phone Number">
            <input type="text" id="regTg" class="form-control" placeholder="Telegram (@username)">
        </div>
        <input type="email" id="authEmail" class="form-control" placeholder="Email Address">
        <input type="password" id="authPass" class="form-control" placeholder="Password">
        <button onclick="handleAuth()" id="mainBtn" class="btn btn-primary w-100 fw-bold">Log In</button>
        <p class="mt-3 text-muted small cursor-pointer" onclick="toggleAuth()">Create an account</p>
    </div>
</div>

<div id="dashSection" class="ide-container hidden">
    
    <div class="ide-navbar">
        <div class="d-flex align-items-center">
            <i class="fas fa-bars me-3 d-md-none cursor-pointer" onclick="toggleSidebar()"></i>
            <span class="fw-bold text-primary me-2">DevPush</span> 
            <span class="text-muted" id="headerProjectName"></span>
        </div>
        <div class="d-flex align-items-center gap-3">
            <span class="badge bg-secondary" id="userStatus">Loading...</span>
            <a href="#" id="livePreviewBtn" target="_blank" class="text-white text-decoration-none disabled" title="Run Live"><i class="fas fa-play text-success"></i></a>
            <i class="fas fa-sign-out-alt text-danger cursor-pointer" onclick="logout()" title="Logout"></i>
        </div>
    </div>

    <div class="main-area">
        <div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span>Projects</span>
                <i class="fas fa-plus cursor-pointer text-white" onclick="createProject()" title="New Project"></i>
            </div>
            <div id="projectList" class="file-tree" style="max-height: 200px; border-bottom: 1px solid #333;"></div>
            
            <div class="sidebar-header mt-2">
                <span>Explorer</span>
                <div class="d-flex gap-2">
                    <i class="fas fa-folder-plus cursor-pointer text-white" onclick="createNewFolder()" title="New Folder"></i>
                    <i class="fas fa-file-medical cursor-pointer text-white" onclick="createNewFile()" title="New File"></i>
                </div>
            </div>
            <div id="fileList" class="file-tree"></div>
            
            <div class="p-2 border-top border-dark text-center">
                <a href="https://t.me/julfikerhossenshebbir" target="_blank" class="btn btn-sm btn-outline-primary w-100">Contact Admin</a>
            </div>
        </div>

        <div class="editor-wrapper">
            <div id="pendingOverlay" class="position-absolute w-100 h-100 d-flex justify-content-center align-items-center z-3 hidden" style="background: rgba(30,30,30,0.95);">
                <div class="text-center text-muted">
                    <i class="fas fa-lock fa-3x mb-3 text-warning"></i>
                    <h5>Access Restricted</h5>
                    <p class="small">Waiting for admin approval.</p>
                </div>
            </div>

            <div class="tab-bar">
                <div class="active-tab">
                    <i class="fas fa-file-code text-warning me-2"></i>
                    <span id="tabFileName">Welcome</span>
                    <i class="fas fa-circle ms-2 text-white" style="font-size: 8px; opacity: 0;" id="unsavedIndicator"></i>
                </div>
                <div class="ms-auto me-3">
                    <button onclick="saveFile()" class="btn btn-sm btn-primary px-3" style="font-size: 0.8rem;">Save</button>
                </div>
            </div>

            <textarea id="codeEditorArea"></textarea>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>

<script>
    const API = 'https://staxteam.com/manager.php';
    const DOMAIN = 'https://staxteam.com/'; 
    let isLogin = true, currentUser = null, activeProject = null, editor;

    // --- Core & Init ---
    window.onload = function() {
        editor = CodeMirror.fromTextArea(document.getElementById("codeEditorArea"), {
            mode: "htmlmixed",
            theme: "vscode-dark",
            lineNumbers: true,
            autoCloseTags: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 4,
            tabSize: 4
        });

        // Draft & Unsaved Indicator
        editor.on("change", function() {
            document.getElementById("unsavedIndicator").style.opacity = "1";
            localStorage.setItem("devPushDraft", editor.getValue());
        });

        const savedUser = localStorage.getItem("devPushUser");
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            activeProject = localStorage.getItem("devPushActiveProj");
            loadDashboard();
        } else {
            document.getElementById('authSection').classList.remove('hidden');
        }
    };

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('mobileOverlay').classList.toggle('open');
    }

    function toggleAuth() {
        isLogin = !isLogin;
        document.getElementById('regFields').classList.toggle('hidden');
        document.getElementById('mainBtn').innerText = isLogin ? 'Log In' : 'Create Account';
    }

    async function apiCall(payload) {
        const res = await fetch(API, { method: 'POST', body: JSON.stringify(payload) });
        return await res.json();
    }

    async function handleAuth() {
        const payload = {
            action: isLogin ? 'login' : 'register', email: document.getElementById('authEmail').value,
            password: document.getElementById('authPass').value, name: document.getElementById('regName').value,
            phone: document.getElementById('regPhone').value, telegram: document.getElementById('regTg').value
        };
        try {
            const data = await apiCall(payload);
            if (data.status === 'success') {
                if (isLogin) {
                    currentUser = data.user;
                    localStorage.setItem("devPushUser", JSON.stringify(currentUser));
                    loadDashboard();
                } else {
                    Swal.fire('Success', 'Wait for admin approval.', 'success');
                    toggleAuth();
                }
            } else Swal.fire('Error', data.message, 'error');
        } catch (err) { Swal.fire('Error', 'Connection failed!', 'error'); }
    }

    function loadDashboard() {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('dashSection').classList.remove('hidden');
        
        document.getElementById('userStatus').innerText = currentUser.status.toUpperCase();
        if (currentUser.status === 'active') {
            document.getElementById('userStatus').className = "badge bg-success";
            document.getElementById('pendingOverlay').classList.add('hidden');
            loadProjects();
            
            // Restore Draft
            const draft = localStorage.getItem("devPushDraft");
            const draftFile = localStorage.getItem("devPushDraftFile");
            if (draft && draftFile) {
                document.getElementById("tabFileName").innerText = draftFile;
                editor.setValue(draft);
            }
            setTimeout(() => editor.refresh(), 200);
        } else {
            document.getElementById('pendingOverlay').classList.remove('hidden');
        }
    }

    // --- Validation Helper ---
    function isValidFile(name) {
        return /\.(html|css|js)$/i.test(name);
    }

    // --- Projects ---
    async function loadProjects() {
        const data = await apiCall({ action: 'list_projects', userId: currentUser.id });
        if(data.status === 'success') {
            currentUser.projects = data.projects;
            const listDiv = document.getElementById('projectList');
            listDiv.innerHTML = '';
            
            currentUser.projects.forEach(proj => {
                const isActive = activeProject === proj ? 'active' : '';
                listDiv.innerHTML += `
                    <div class="tree-item ${isActive}" onclick="selectProject('${proj}')">
                        <i class="fas fa-globe text-primary me-2"></i> ${proj}
                        <div class="file-actions">
                            <i class="fas fa-trash text-danger" onclick="event.stopPropagation(); deleteProject('${proj}')"></i>
                        </div>
                    </div>`;
            });
            if(activeProject && currentUser.projects.includes(activeProject)) selectProject(activeProject);
        }
    }

    async function createProject() {
        if(currentUser.projects.length >= 5) return Swal.fire('Limit', 'Max 5 projects.', 'warning');
        const { value: projName } = await Swal.fire({ title: 'Project Name', input: 'text', showCancelButton: true });
        if (projName) {
            const data = await apiCall({ action: 'create_project', userId: currentUser.id, projectName: projName });
            if(data.status === 'success') loadProjects(); else Swal.fire('Error', data.message, 'error');
        }
    }

    function deleteProject(projName) {
        Swal.fire({ title: 'Delete Project?', text: "Permanent Action", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' })
        .then(async (result) => {
            if (result.isConfirmed) {
                const data = await apiCall({ action: 'delete_project', userId: currentUser.id, projectName: projName });
                if(data.status === 'success') {
                    if(activeProject === projName) { activeProject = null; localStorage.removeItem("devPushActiveProj"); }
                    loadProjects(); fetchFiles();
                }
            }
        });
    }

    function selectProject(projName) {
        activeProject = projName;
        localStorage.setItem("devPushActiveProj", projName);
        document.getElementById('headerProjectName').innerText = `/ ${projName}`;
        
        const btn = document.getElementById('livePreviewBtn');
        btn.href = `${DOMAIN}${projName}/`;
        btn.classList.remove('disabled');
        
        loadProjects(); fetchFiles();
    }

    // --- Files & Folders ---
    async function fetchFiles() {
        if(!activeProject) { document.getElementById('fileList').innerHTML = ''; return; }
        const data = await apiCall({ action: 'list_files', userId: currentUser.id, projectName: activeProject });
        const listDiv = document.getElementById('fileList');
        listDiv.innerHTML = '';

        if (data.files && data.files.length > 0) {
            data.files.forEach(file => {
                // Folder Visualization Logic
                let display = file;
                let folderPart = '';
                let filePart = file;
                let icon = 'fa-file-code';
                let color = 'text-muted';

                if(file.includes('/')) {
                    const parts = file.split('/');
                    filePart = parts.pop();
                    folderPart = parts.join('/') + '/';
                }

                if(file.endsWith('.html')) { icon = 'fa-html5'; color = 'text-danger'; }
                if(file.endsWith('.css')) { icon = 'fa-css3-alt'; color = 'text-info'; }
                if(file.endsWith('.js')) { icon = 'fa-js'; color = 'text-warning'; }

                listDiv.innerHTML += `
                    <div class="tree-item" onclick="loadFile('${file}')">
                        <i class="fab ${icon} ${color} me-2"></i>
                        <span class="folder-part">${folderPart}</span>
                        <span class="file-part">${filePart}</span>
                        <div class="file-actions">
                            <i class="fas fa-pen" onclick="event.stopPropagation(); renameFile('${file}')"></i>
                            <i class="fas fa-trash" onclick="event.stopPropagation(); deleteFile('${file}')"></i>
                        </div>
                    </div>`;
            });
        } else {
            listDiv.innerHTML = '<div class="p-3 text-muted small text-center">Empty project.</div>';
        }
    }

    async function createNewFolder() {
        const { value: folderName } = await Swal.fire({ title: 'New Folder', input: 'text', placeholder: 'assets/css', showCancelButton: true });
        if (folderName) {
            const data = await apiCall({ action: 'create_folder', userId: currentUser.id, projectName: activeProject, folderName: folderName });
            if(data.status === 'success') fetchFiles();
        }
    }

    async function createNewFile() {
        const { value: fileName } = await Swal.fire({ title: 'New File', input: 'text', placeholder: 'style.css', showCancelButton: true });
        if (fileName) {
            if(!isValidFile(fileName)) return Swal.fire('Blocked', 'Only .html, .css, .js files allowed!', 'error');
            
            document.getElementById('tabFileName').innerText = fileName;
            localStorage.setItem("devPushDraftFile", fileName);
            editor.setValue("");
            editor.setOption("mode", getMode(fileName));
            saveFile(); // Auto save empty file to create it
        }
    }

    async function renameFile(oldName) {
        const { value: newName } = await Swal.fire({ title: 'Rename', input: 'text', inputValue: oldName, showCancelButton: true });
        if (newName && newName !== oldName) {
            if(!isValidFile(newName)) return Swal.fire('Blocked', 'Invalid file extension!', 'error');
            
            const data = await apiCall({ action: 'rename_file', userId: currentUser.id, projectName: activeProject, oldName: oldName, newName: newName });
            if(data.status === 'success') { fetchFiles(); document.getElementById('tabFileName').innerText = newName; }
            else Swal.fire('Error', data.message, 'error');
        }
    }

    async function loadFile(fileName) {
        document.getElementById('tabFileName').innerText = fileName;
        localStorage.setItem("devPushDraftFile", fileName);
        editor.setOption("mode", getMode(fileName));

        const data = await apiCall({ action: 'read_file', userId: currentUser.id, projectName: activeProject, fileName: fileName });
        if(data.status === 'success') {
            editor.setValue(data.content);
            document.getElementById("unsavedIndicator").style.opacity = "0";
            if(window.innerWidth <= 768) toggleSidebar();
        }
    }

    async function saveFile() {
        if(!activeProject) return Swal.fire('Info', 'Open a project first', 'info');
        const fName = localStorage.getItem("devPushDraftFile");
        if(!fName) return Swal.fire('Info', 'Create a file first', 'info');

        const data = await apiCall({ action: 'file_op', operation: 'write', userId: currentUser.id, projectName: activeProject, fileName: fName, content: editor.getValue() });
        if(data.status === 'success') {
            document.getElementById("unsavedIndicator").style.opacity = "0";
            localStorage.removeItem("devPushDraft");
            const Toast = Swal.mixin({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500 });
            Toast.fire({ icon: 'success', title: 'Saved' });
            fetchFiles();
        } else Swal.fire('Error', data.message, 'error');
    }

    function deleteFile(fileName) {
        Swal.fire({ title: 'Delete?', text: fileName, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' })
        .then((result) => {
            if (result.isConfirmed) {
                apiCall({ action: 'file_op', operation: 'delete', userId: currentUser.id, projectName: activeProject, fileName: fileName })
                .then(data => { if(data.status === 'success') fetchFiles(); });
            }
        });
    }

    function getMode(name) {
        if(name.endsWith('.css')) return 'css';
        if(name.endsWith('.js')) return 'javascript';
        return 'htmlmixed';
    }

    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
