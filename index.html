<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevPush | VS Code Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/vscode-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { 
            --bg-activity: #333333; --bg-sidebar: #252526; --bg-editor: #1e1e1e;
            --bg-status: #007acc; --border: #3e3e42; --text: #cccccc; --text-active: #ffffff;
            --hover: #2a2d2e; --active-item: #37373d;
        }
        body { background: #000; color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; }
        .hidden { display: none !important; }

        /* Login Screen */
        .auth-wrapper { height: 100vh; display: flex; align-items: center; justify-content: center; background: #0d1117; }
        .auth-card { background: #161b22; padding: 40px; border: 1px solid #30363d; border-radius: 6px; width: 350px; }
        .auth-card input { background: #0d1117; border: 1px solid #30363d; color: white; margin-bottom: 15px; }
        .auth-card input:focus { border-color: #58a6ff; box-shadow: none; }

        /* Main Layout */
        .ide-wrapper { display: flex; height: 100vh; flex-direction: column; }
        
        /* Navbar */
        .title-bar { background: #3c3c3c; height: 35px; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; font-size: 13px; user-select: none; }
        
        /* Workspace */
        .workspace { display: flex; flex: 1; overflow: hidden; }
        
        /* Activity Bar (Left Vertical) */
        .activity-bar { width: 48px; background: var(--bg-activity); display: flex; flex-direction: column; align-items: center; padding-top: 10px; }
        .activity-icon { font-size: 24px; color: #858585; margin-bottom: 25px; cursor: pointer; position: relative; }
        .activity-icon.active { color: white; border-left: 2px solid white; }
        .activity-icon:hover { color: white; }

        /* Sidebar (Explorer) */
        .sidebar { width: 250px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 10px 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; color: #bbbbbb; }
        .explorer-content { flex: 1; overflow-y: auto; padding-top: 5px; }
        
        /* File Tree Items */
        .tree-node { padding: 3px 0; cursor: pointer; white-space: nowrap; font-size: 13px; display: flex; align-items: center; }
        .tree-node:hover { background: var(--hover); }
        .tree-node.selected { background: var(--active-item); color: white; }
        .indent { display: inline-block; width: 15px; }
        .node-icon { width: 16px; text-align: center; margin-right: 5px; font-size: 14px; }
        .node-text { flex: 1; overflow: hidden; text-overflow: ellipsis; }
        .node-actions { display: none; margin-right: 10px; gap: 8px; font-size: 12px; }
        .tree-node:hover .node-actions { display: flex; }
        
        /* Editor Area */
        .editor-area { flex: 1; background: var(--bg-editor); display: flex; flex-direction: column; position: relative; }
        .tabs-header { height: 35px; background: #2d2d2d; display: flex; align-items: center; overflow-x: auto; }
        .tab { background: #2d2d2d; color: #969696; padding: 8px 15px; font-size: 13px; border-right: 1px solid #252526; cursor: pointer; display: flex; align-items: center; }
        .tab.active { background: var(--bg-editor); color: white; border-top: 1px solid var(--bg-status); }
        .tab-close { margin-left: 8px; font-size: 10px; opacity: 0; }
        .tab:hover .tab-close { opacity: 1; }
        
        /* Status Bar */
        .status-bar { height: 22px; background: var(--bg-status); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; font-size: 12px; }

        .CodeMirror { flex: 1; font-family: 'Fira Code', monospace; font-size: 14px; }

        @media (max-width: 768px) {
            .activity-bar { display: none; }
            .sidebar { position: absolute; z-index: 100; height: 100%; left: -100%; transition: 0.2s; box-shadow: 5px 0 10px rgba(0,0,0,0.5); }
            .sidebar.open { left: 0; }
            .mobile-toggle { display: block !important; margin-right: 10px; cursor: pointer; }
        }
        .mobile-toggle { display: none; }
    </style>
</head>
<body>

<div id="authSection" class="auth-wrapper hidden">
    <div class="auth-card">
        <div class="text-center mb-4"><i class="fas fa-code text-primary fa-2x"></i></div>
        <input type="text" id="regName" class="form-control hidden" placeholder="Full Name">
        <input type="email" id="authEmail" class="form-control" placeholder="Email">
        <input type="password" id="authPass" class="form-control" placeholder="Password">
        <button onclick="handleAuth()" id="mainBtn" class="btn btn-primary w-100 btn-sm fw-bold">Login</button>
        <div class="text-center mt-3 small text-secondary cursor-pointer" onclick="toggleAuth()">Create Account</div>
        
        <div id="regExtras" class="hidden">
            <input type="text" id="regPhone" class="form-control mt-3" placeholder="Phone">
            <input type="text" id="regTg" class="form-control" placeholder="Telegram User">
        </div>
    </div>
</div>

<div id="dashSection" class="ide-wrapper hidden">
    <div class="title-bar">
        <div class="d-flex align-items-center">
            <i class="fas fa-bars mobile-toggle" onclick="toggleSidebar()"></i>
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/9a/Visual_Studio_Code_1.35_icon.svg" width="18" class="me-2">
            <span>DevPush - <span id="headerProjectName">No Project</span></span>
        </div>
        <div class="d-flex align-items-center gap-3">
             <span id="userStatus" class="badge bg-secondary">Loading</span>
             <a href="#" id="livePreviewBtn" target="_blank" class="text-decoration-none text-light" title="Run"><i class="fas fa-play text-success"></i></a>
             <i class="fas fa-sign-out-alt text-danger cursor-pointer" onclick="logout()"></i>
        </div>
    </div>

    <div class="workspace">
        <div class="activity-bar">
            <div class="activity-icon active" onclick="showPanel('explorer')"><i class="far fa-copy"></i></div>
            <div class="activity-icon" onclick="showPanel('projects')"><i class="fas fa-cubes"></i></div>
        </div>

        <div class="sidebar" id="sidebar">
            <div id="panel-projects" class="hidden h-100 d-flex flex-column">
                <div class="sidebar-header">
                    <span>MY PROJECTS (<span id="projCount">0</span>/5)</span>
                    <i class="fas fa-plus cursor-pointer" onclick="createProject()"></i>
                </div>
                <div id="projectList" class="explorer-content"></div>
            </div>

            <div id="panel-explorer" class="h-100 d-flex flex-column">
                <div class="sidebar-header">
                    <span>EXPLORER</span>
                    <div class="d-flex gap-2">
                        <i class="fas fa-folder-plus cursor-pointer" onclick="createFolder()" title="New Folder"></i>
                        <i class="fas fa-file-medical cursor-pointer" onclick="createFile()" title="New File"></i>
                    </div>
                </div>
                <div id="fileTree" class="explorer-content">
                    <div class="p-3 text-muted small text-center">Select a project first</div>
                </div>
            </div>
        </div>

        <div class="editor-area">
            <div id="pendingOverlay" class="position-absolute w-100 h-100 d-flex justify-content-center align-items-center z-3 hidden" style="background: rgba(30,30,30,0.95);">
                <div class="text-center">
                    <i class="fas fa-lock fa-3x mb-3 text-warning"></i>
                    <h5>Workspace Locked</h5>
                    <p class="small text-muted">Admin approval required.</p>
                </div>
            </div>

            <div class="tabs-header">
                <div class="tab active">
                    <i class="fas fa-file-code text-warning me-2"></i> 
                    <span id="activeTabName">Welcome</span>
                    <span class="tab-close" onclick="closeTab()">âœ•</span>
                </div>
                <div class="ms-auto me-2">
                    <button class="btn btn-sm btn-primary py-0" style="font-size:11px;" onclick="saveFile()">Save</button>
                </div>
            </div>
            
            <textarea id="codeEditorArea"></textarea>

            <div class="status-bar">
                <div class="d-flex gap-3">
                    <span><i class="fas fa-code-branch"></i> main</span>
                    <span id="cursorPos">Ln 1, Col 1</span>
                </div>
                <div class="d-flex gap-3">
                    <span id="langMode">HTML</span>
                    <span>UTF-8</span>
                    <span>Prettier</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>

<script>
    const API = 'https://staxteam.com/manager.php';
    const DOMAIN = 'https://staxteam.com/';
    let isLogin = true, currentUser = null, activeProject = null, editor;
    let expandedFolders = new Set(); // To keep folders open

    // --- Init ---
    window.onload = function() {
        editor = CodeMirror.fromTextArea(document.getElementById("codeEditorArea"), {
            mode: "htmlmixed", theme: "vscode-dark", lineNumbers: true, 
            autoCloseTags: true, autoCloseBrackets: true, indentUnit: 4
        });

        editor.on("cursorActivity", () => {
            const pos = editor.getCursor();
            document.getElementById("cursorPos").innerText = `Ln ${pos.line + 1}, Col ${pos.ch + 1}`;
        });

        editor.on("change", () => {
            localStorage.setItem("devPushDraft", editor.getValue());
        });

        const savedUser = localStorage.getItem("devPushUser");
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            activeProject = localStorage.getItem("devPushActiveProj");
            loadDashboard();
        } else {
            document.getElementById('authSection').classList.remove('hidden');
        }
    };

    // --- Tree Builder Logic ---
    function buildTree(items) {
        let root = {};
        items.forEach(item => {
            let parts = item.path.split('/');
            let current = root;
            parts.forEach((part, i) => {
                if (!current[part]) {
                    current[part] = { 
                        name: part, 
                        path: parts.slice(0, i + 1).join('/'),
                        type: (i === parts.length - 1) ? item.type : 'folder',
                        children: {} 
                    };
                }
                current = current[part].children;
            });
        });
        return root;
    }

    function renderTree(node, indent = 0) {
        let html = '';
        // Sort: Folders first
        let keys = Object.keys(node).sort((a, b) => {
            if(node[a].type === node[b].type) return a.localeCompare(b);
            return node[a].type === 'folder' ? -1 : 1;
        });

        keys.forEach(key => {
            let item = node[key];
            let isFolder = item.type === 'folder';
            let icon = isFolder ? (expandedFolders.has(item.path) ? 'fa-folder-open text-muted' : 'fa-folder text-muted') : getFileIcon(item.name);
            let arrow = isFolder ? (expandedFolders.has(item.path) ? 'fa-chevron-down' : 'fa-chevron-right') : '';
            let padding = indent * 15 + 10;
            let displayChildren = (isFolder && expandedFolders.has(item.path)) ? 'block' : 'none';

            html += `
            <div class="tree-group">
                <div class="tree-node" style="padding-left: ${padding}px" onclick="handleNodeClick('${item.path}', '${item.type}')">
                    <i class="fas ${arrow} me-1" style="font-size:10px; width:10px; visibility: ${isFolder ? 'visible' : 'hidden'}"></i>
                    <i class="fas ${icon} node-icon"></i>
                    <span class="node-text">${item.name}</span>
                    <div class="node-actions">
                         <i class="fas fa-pen" onclick="event.stopPropagation(); renameItem('${item.path}')"></i>
                         <i class="fas fa-trash text-danger" onclick="event.stopPropagation(); deleteItem('${item.path}')"></i>
                    </div>
                </div>
                <div style="display: ${displayChildren}">
                    ${renderTree(item.children, indent + 1)}
                </div>
            </div>`;
        });
        return html;
    }

    // --- Actions ---
    function handleNodeClick(path, type) {
        if (type === 'folder') {
            if (expandedFolders.has(path)) expandedFolders.delete(path);
            else expandedFolders.add(path);
            refreshFileTree(); // Re-render to show/hide children
        } else {
            loadFile(path);
        }
    }

    async function refreshFileTree() {
        if(!activeProject) return;
        const res = await apiCall({ action: 'list_files', userId: currentUser.id, projectName: activeProject });
        if(res.status === 'success') {
            const treeRoot = buildTree(res.items);
            document.getElementById('fileTree').innerHTML = renderTree(treeRoot);
        }
    }

    // --- Core Functions ---
    async function createProject() {
        if(currentUser.projects.length >= 5) return Swal.fire('Limit', 'Max 5 Projects', 'warning');
        const { value: name } = await Swal.fire({ title: 'New Project', input: 'text', showCancelButton: true });
        if(name) {
            const res = await apiCall({ action: 'create_project', userId: currentUser.id, projectName: name });
            if(res.status === 'success') loadProjects(); else Swal.fire('Error', res.message, 'error');
        }
    }

    async function loadProjects() {
        const res = await apiCall({ action: 'list_projects', userId: currentUser.id });
        if(res.status === 'success') {
            currentUser.projects = res.projects;
            document.getElementById('projCount').innerText = currentUser.projects.length;
            document.getElementById('projectList').innerHTML = currentUser.projects.map(p => `
                <div class="tree-node ps-3 ${activeProject === p ? 'selected' : ''}" onclick="selectProject('${p}')">
                    <i class="fas fa-cube text-info node-icon"></i> <span class="node-text">${p}</span>
                    <i class="fas fa-trash text-danger node-actions" onclick="deleteProject('${p}')"></i>
                </div>`).join('');
            if(activeProject) selectProject(activeProject);
        }
    }

    function selectProject(name) {
        activeProject = name;
        localStorage.setItem("devPushActiveProj", name);
        document.getElementById('headerProjectName').innerText = name;
        document.getElementById('livePreviewBtn').href = `${DOMAIN}${name}/`;
        showPanel('explorer');
        refreshFileTree();
    }

    async function createFolder() {
        const { value: name } = await Swal.fire({ title: 'Folder Name', input: 'text', placeholder: 'css', showCancelButton: true });
        if(name) {
            const res = await apiCall({ action: 'create_folder', userId: currentUser.id, projectName: activeProject, folderName: name });
            if(res.status === 'success') refreshFileTree();
        }
    }

    async function createFile() {
        const { value: name } = await Swal.fire({ title: 'File Name', input: 'text', placeholder: 'style.css', showCancelButton: true });
        if(name) {
            if(!/\.(html|css|js)$/.test(name)) return Swal.fire('Error', 'Only .html .css .js', 'error');
            loadFile(name, true); // True = New File
            editor.setValue("");
            saveFile();
        }
    }

    async function loadFile(path, isNew = false) {
        document.getElementById('activeTabName').innerText = path;
        localStorage.setItem("devPushDraftFile", path);
        setMode(path);
        
        if(!isNew) {
            const res = await apiCall({ action: 'read_file', userId: currentUser.id, projectName: activeProject, fileName: path });
            if(res.status === 'success') editor.setValue(res.content);
        }
        
        if(window.innerWidth <= 768) toggleSidebar();
    }

    async function saveFile() {
        const path = localStorage.getItem("devPushDraftFile");
        if(!path) return;
        const res = await apiCall({ action: 'file_op', operation: 'write', userId: currentUser.id, projectName: activeProject, fileName: path, content: editor.getValue() });
        if(res.status === 'success') {
            const Toast = Swal.mixin({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 1500 });
            Toast.fire({ icon: 'success', title: 'Saved' });
            refreshFileTree();
        }
    }

    async function deleteItem(path) {
        Swal.fire({ title: 'Delete?', text: path, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }).then(async (r) => {
            if(r.isConfirmed) {
                const res = await apiCall({ action: 'file_op', operation: 'delete', userId: currentUser.id, projectName: activeProject, fileName: path });
                if(res.status === 'success') refreshFileTree();
            }
        });
    }
    
    // --- Helpers ---
    function getFileIcon(name) {
        if(name.endsWith('.html')) return 'fa-html5 text-danger';
        if(name.endsWith('.css')) return 'fa-css3-alt text-info';
        if(name.endsWith('.js')) return 'fa-js text-warning';
        return 'fa-file-code';
    }

    function setMode(name) {
        let mode = 'htmlmixed';
        if(name.endsWith('.css')) mode = 'css';
        if(name.endsWith('.js')) mode = 'javascript';
        editor.setOption("mode", mode);
        document.getElementById('langMode').innerText = mode.toUpperCase();
    }

    function showPanel(panelId) {
        document.querySelectorAll('.activity-icon').forEach(el => el.classList.remove('active'));
        document.getElementById('panel-projects').classList.add('hidden');
        document.getElementById('panel-explorer').classList.add('hidden');
        
        document.getElementById(`panel-${panelId}`).classList.remove('hidden');
        // Add active class logic here if needed for icons
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    function toggleAuth() { 
        document.getElementById('regName').classList.toggle('hidden');
        document.getElementById('regExtras').classList.toggle('hidden');
        isLogin = !isLogin; 
        document.getElementById('mainBtn').innerText = isLogin ? 'Login' : 'Sign Up';
    }
    
    async function handleAuth() {
        const payload = {
            action: isLogin ? 'login' : 'register', email: document.getElementById('authEmail').value,
            password: document.getElementById('authPass').value, name: document.getElementById('regName').value,
            phone: document.getElementById('regPhone').value, telegram: document.getElementById('regTg').value
        };
        const res = await apiCall(payload);
        if(res.status === 'success') {
            if(isLogin) { currentUser = res.user; localStorage.setItem("devPushUser", JSON.stringify(currentUser)); loadDashboard(); }
            else { Swal.fire('Success', 'Wait for approval', 'success'); toggleAuth(); }
        } else Swal.fire('Error', res.message, 'error');
    }

    async function apiCall(data) { return (await fetch(API, { method: 'POST', body: JSON.stringify(data) })).json(); }
    function logout() { localStorage.clear(); location.reload(); }
    function loadDashboard() { 
        document.getElementById('authSection').classList.add('hidden'); 
        document.getElementById('dashSection').classList.remove('hidden');
        if(currentUser.status === 'active') {
             document.getElementById('userStatus').className = 'badge bg-success';
             document.getElementById('userStatus').innerText = 'Active';
             document.getElementById('pendingOverlay').classList.add('hidden');
             loadProjects();
        } else document.getElementById('pendingOverlay').classList.remove('hidden');
    }
</script>
</body>
</html>
